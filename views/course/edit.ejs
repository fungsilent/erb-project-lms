<div class="container mt-4">
    <h2>Edit Course</h2>
    <form id="editCourseForm">
        <input type="hidden" id="courseId" name="id" />
        <div class="form-group">
            <label for="course_name">Course Name:</label>
            <input
                type="text"
                class="form-control"
                id="course_name"
                name="name"
                required
            />
        </div>
        <div class="form-group">
            <label for="description">Description:</label>
            <textarea
                class="form-control"
                id="description"
                name="description"
                rows="3"
            ></textarea>
        </div>
        <div class="form-group">
            <label for="teacher">Teacher:</label>
            <select class="form-control" id="teacher" name="teacher" required>
                <template id="teacherOption">
                    <option value="${value}">${text}</option>
                </template>
            </select>
        </div>
        <div class="form-group">
            <label for="startDate">Start Date:</label>
            <input
                type="text"
                class="form-control"
                id="startDate"
                name="startDate"
                required
            />
        </div>
        <div class="form-group">
            <label for="endDate">End Date:</label>
            <input
                type="text"
                class="form-control"
                id="endDate"
                name="endDate"
                required
            />
        </div>
        <div class="form-group">
            <label for="maxStudents">Max Students:</label>
            <input
                type="number"
                class="form-control"
                id="maxStudents"
                name="maxStudents"
                required
            />
        </div>
        <div class="form-group">
            <label for="excludeDates">Exclude Specific Dates:</label>
            <input
                type="text"
                class="form-control"
                id="excludeDates"
                name="excludeDates"
                placeholder="Select dates"
            />
        </div>
        <div class="form-group">
            <label for="students">Assign Students:</label>
            <select multiple class="form-control" id="students" name="students">
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </form>
</div>
<script>
    $(document).ready(() => {
        const courseId = window.location.pathname.split('/').pop();

        $.ajax({
            url: `/api/course/${courseId}`,
            method: 'GET',
            success: response => {
                console.log('response', response);
                if (response.success) {
                    const { course } = response.data;
                    $('#courseId').val(course._id);
                    $('#course_name').val(course.name);
                    $('#description').val(course.description);
                    $('#teacher').val(course.teacher._id);
                    $('#startDate').flatpickr({
                        dateFormat: 'Y-m-d',
                        defaultDate: course.startDate.split('T')[0],
                    });
                    $('#endDate').flatpickr({
                        dateFormat: 'Y-m-d',
                        defaultDate: course.endDate.split('T')[0],
                    });
                    $('#maxStudents').val(course.maxStudents);

                    $('#excludeDates').flatpickr({
                        mode: 'multiple',
                        dateFormat: 'Y-m-d',
                        defaultDate: course.excludeDates.map(date => date.split('T')[0]), 
                    });

                    course.students.forEach(student => {
                        $('#students').append(
                            `<option value="${student._id}" selected>${student.name}</option>`
                        );
                    });

                    $.ajax({
                        url: '/api/course/option',
                        method: 'GET',
                        success: response => {
                            console.log('response', response);
                            if (!response.success) return;
                            const { teachers, students } = response.data;
                            teachers.forEach(teacher => {
                                $.cloneTemplate('#teacherOption', {
                                    text: teacher.name,
                                    value: teacher._id,
                                });
                            });
                            students.forEach(student => {
                                const isAssigned = course.students.some(
                                    assignedStudent => assignedStudent._id === student._id
                                );
                                if (!isAssigned) {
                                    $('#students').append(
                                        `<option value="${student._id}">${student.name}</option>`
                                    );
                                }
                            });

                            $('#students').select2();
                        },
                    });

                } else {
                    alert(`An error occurred: ${response.message}`);
                }
            },
        });

        $('#editCourseForm').on('submit', event => {
            event.preventDefault();
            const data = $.getFormData('#editCourseForm');
            $.ajax({
                url: `/api/course/${courseId}`,
                method: 'PUT',
                data,
                success: response => {
                    console.log('response', response);
                    if (response.success) {
                        window.location.href = '/course';
                    } else {
                        alert(`An error occurred: ${response.message}`);
                    }
                },
            });
        });
    });
</script>
<%- contentFor('title') %>Edit Course
