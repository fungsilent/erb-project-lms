<div class="container mt-4">
    <h2>Courses</h2>
    <a href="/course/add" class="btn btn-primary mb-3 admin hide">Add New Course</a>

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Name</th>
                <th>Teacher</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th >Students</th>
                <th >Detail</th>
                <th class="admin hide">Actions</th>
            </tr>
        </thead>
        <tbody>
            <template id="courseItem">
                <tr>
                    <td>${name}</td>
                    <td>${teacher}</td>
                    <td>${startDate}</td>
                    <td >${endDate}</td>
                    <td >${students}</td>
                    <td>
                        <a href="/course/detail/${id}" class="btn btn-outline-secondary btn-sm" >Link</a>
                    </td>
                    <td class="admin hide">
                        <a
                            href="/course/edit/${id}"
                            class="btn btn-secondary btn-sm"
                        >Edit</a>
                        <button
                            class="btn btn-danger btn-sm delete-course"
                            data-id="${id}"
                        >
                            Delete
                        </button>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>
</div>

<script>
    $(document).ready(() => {
        $(document).on('userInfoEvent', (event, user) => {
            $.ajax({
                url: '/api/course/',
                method: 'GET',
                success: response => {
                    console.log('response', response)
                    if (!response.success) return

                    response.data.forEach(course => {
                        const elem = $.cloneTemplate('#courseItem', {
                            id: course._id,
                            name: course.name,
                            teacher: course.teacher.name,
                            startDate: new Date(course.startDate).toLocaleDateString(),
                            endDate: new Date(course.endDate).toLocaleDateString(),
                            students: `${course.students.length}/${course.maxStudents}`,
                        }, {
                            insert: false
                        })
                        console.log(course)
                        elem.find(`.${user.role}`).removeClass('hide')
                        $('#courseItem').before(elem)
                    })

                },
            })  
        })

        $(document).on('click', '.delete-course', event => {
            if (confirm('Are you sure you want to delete this course?')) {
                const courseId = $(event.target).data('id')
                console.log(courseId)
                $.ajax({
                    url: `/api/course/${courseId}`,
                    method: 'DELETE',
                    success: response => {
                        if (response.success) {
                            location.reload()
                        } else {
                            alert('An error occurred: ' + response.message)
                        }
                    },
                    error: (xhr, status, error) => {
                        console.error('Error:', error)
                        alert('An error occurred. Please try again.')
                    },
                })
            }
        })
    })
</script>
<%- contentFor('title') %>Course
