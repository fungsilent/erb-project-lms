<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>
<script>
    $(document).ready(() => {
        const calendar = new FullCalendar.Calendar($('#calendar').get(0), {
            initialView: 'dayGridMonth',
            initialDate: new Date(),
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay',
            },
            events: async (fetchInfo, successCallback, failureCallback) => {
                await $.ajax({
                    url: `/api/calendar/events`,
                    method: 'GET',
                    success: response => {
                        console.log('response', response)
                        if (response.success) {
                            const courses = response.data

                            const events = courses
                                .map(course => {
                                    const startDate = moment(course.startDate)
                                    const endDate = moment(course.endDate)
                                    const excludeDates = course.excludeDates
                                        ? course.excludeDates.map(date =>
                                              moment(date).format('YYYY-MM-DD')
                                          )
                                        : []
                                    let dates = []

                                    while (startDate.isSameOrBefore(endDate)) {
                                        if (
                                            !excludeDates.includes(
                                                startDate.format('YYYY-MM-DD')
                                            )
                                        ) {
                                            dates.push({
                                                title: course.name,
                                                start: startDate.format(
                                                    'YYYY-MM-DD'
                                                ),
                                                allDay: true,
                                            })
                                        }
                                        startDate.add(1, 'days')
                                    }
                                    return dates
                                })
                                .flat()

                            successCallback(events)
                        } else {
                            failureCallback(response.message)
                        }
                    },
                })
            },
        })
        calendar.render()
    })
</script>

<h1>Timetable</h1>
<div id="calendar"></div>
<%- contentFor('title') %>Calendar
