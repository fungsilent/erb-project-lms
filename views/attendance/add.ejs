<div class="container mt-4">
    <h2>Mark Attendance</h2>
    <h3>Course: <span id="courseName"></span></h3>
    <form id="markAttendanceForm">
        <input type="hidden" name="course" id="courseId">
        <div class="form-group">
            <label for="attendanceDate">Date:</label>
            <select id="attendanceDate" name="date" class="form-control"></select>
        </div>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="studentsList">
                <template id="studentItemTemplate">
                    <tr>
                        <td>${name}</td>
                        <td>
                            <select name="status_${studentId}" class="form-control">
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                                <option value="late">Late</option>
                            </select>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
        <button type="submit" class="btn btn-primary">Save Attendance</button>
    </form>
</div>

<script>
    $(document).ready(() => {
        const courseId = window.location.pathname.split('/').pop();

        $.ajax({
            url: `/api/attendance/courses/${courseId}`,
            method: 'GET',
            success: response => {
                if (response.success) {
                    const { course, students, today } = response;

                    $('#courseName').text(course.name);
                    $('#courseId').val(course._id);

                    const excludeDatesSet = new Set(course.excludeDates.map(date => new Date(date).toISOString().split('T')[0]));

                    for (let d = new Date(course.startDate); d <= new Date(course.endDate); d.setDate(d.getDate() + 1)) {
                        const dateString = d.toISOString().split('T')[0];
                        if (!excludeDatesSet.has(dateString)) {
                            const option = new Option(dateString, dateString);
                            if (dateString === today) {
                                option.selected = true; 
                            }
                            $('#attendanceDate').append(option);
                        }
                    }

                    students.forEach(student => {
                        const elem = $.cloneTemplate('#studentItemTemplate', {
                            studentId: student._id,
                            name: student.name
                        }, { insert: false });
                        $('#studentsList').append(elem);
                    });
                } else {
                    alert(`Error fetching course details: ${response.message}`);
                }
            },
            error: err => {
                alert(`An error occurred: ${err.responseText}`);
            }
        });

        $('#markAttendanceForm').on('submit', function(event) {
            event.preventDefault();
            const formData = $(this).serializeArray();
            const attendanceRecords = formData.filter(item => item.name.startsWith('status_')).map(item => ({
                studentId: item.name.split('_')[1],
                status: item.value
            }));

            const data = {
                courseId: courseId,
                date: $('#attendanceDate').val(),
                records: attendanceRecords
            };

            $.ajax({
                url: '/api/attendance/mark',
                method: 'POST',
                data: data,
                success: response => {
                    if (response.success) {
                        alert('Attendance marked successfully');
                        window.location.href = `/attendance`;
                    } else {
                        alert(`Error: ${response.message}`);
                    }
                },
                error: err => {
                    alert(`An error occurred: ${err.responseText}`);
                }
            });
        });
    });
</script>
<%- contentFor('title') %>Mark Attendance
