<div class="p-4">
    <h2>Add Assignment(s) for <span id="courseName"></span></h2>
    <form id="addAssignmentsForm" enctype="multipart/form-data">
        <div id="assignmentsContainer">
            <div class="assignment-form mt-4">
                <h4>Assignment 1</h4>
                <div class="form-group">
                    <label for="name_1">Name:</label>
                    <input type="text" class="form-control" id="name_1" name="name" required>
                </div>
                <div class="form-group">
                    <label for="dueDate_1">Due Date:</label>
                    <input type="text" class="form-control due-date" id="dueDate_1" name="dueDate" required>
                </div>
                <div class="form-group">
                    <label for="totalMarks_1">Total Marks:</label>
                    <input type="number" class="form-control" id="totalMarks_1" name="totalMarks" required>
                </div>
                <div class="form-group">
                    <label for="passingMarks_1">Passing Marks:</label>
                    <input type="number" class="form-control" id="passingMarks_1" name="passingMarks" required>
                </div>
                <div class="form-group">
                    <label for="assignment_1">Assignment File:</label>
                    <input type="file" class="form-control" id="assignment_1" name="assignments" required>
                </div>
            </div>
        </div>
        
        <template id="assignmentTemplate">
            <div class="assignment-form mt-4">
                <h4>Assignment ${assignmentCount}</h4>
                <div class="form-group">
                    <label for="name_${assignmentCount}">Name:</label>
                    <input type="text" class="form-control" id="name_${assignmentCount}" name="name" required>
                </div>
                <div class="form-group">
                    <label for="dueDate_${assignmentCount}">Due Date:</label>
                    <input type="text" class="form-control due-date" id="dueDate_${assignmentCount}" name="dueDate" required>
                </div>
                <div class="form-group">
                    <label for="totalMarks_${assignmentCount}">Total Marks:</label>
                    <input type="number" class="form-control" id="totalMarks_${assignmentCount}" name="totalMarks" required>
                </div>
                <div class="form-group">
                    <label for="passingMarks_${assignmentCount}">Passing Marks:</label>
                    <input type="number" class="form-control" id="passingMarks_${assignmentCount}" name="passingMarks" required>
                </div>
                <div class="form-group">
                    <label for="assignment_${assignmentCount}">Assignment File:</label>
                    <input type="file" class="form-control" id="assignment_${assignmentCount}" name="assignments" required>
                </div>
            </div>
        </template>
        <button type="button" id="addMoreAssignments" class="btn btn-secondary mt-2">Add More Assignment</button>
        <button type="submit" class="btn btn-primary mt-2">Save Assignments</button>
    </form>
</div>

<script>
    $(document).ready(function() {
        const courseId = window.location.pathname.split('/').pop();
        $.ajax({
            url: `/api/assignments/add/${courseId}`,
            method: 'GET',
            success: response => {
                if (response.success) {
                    const { course } = response;
                    $('#courseName').text(course.name);
                } else {
                    alert(`An error occurred: ${response.message}`);
                }
            },
            error: err => {
                alert(`An error occurred: ${err.responseText}`);
            }
        });

        let assignmentCount = 1;
        $('.due-date').flatpickr({ dateFormat: 'Y-m-d' });

        $('#addMoreAssignments').on('click', function() {
            assignmentCount++;
            const newAssignmentForm = $.cloneTemplate('#assignmentTemplate', {
                assignmentCount: assignmentCount
            }, { insert: false });
            $('#assignmentsContainer').append(newAssignmentForm);
            $('.due-date').flatpickr({ dateFormat: 'Y-m-d' });
        });

        $('#addAssignmentsForm').on('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);

            const files = document.querySelectorAll('input[type="file"]');

            files.forEach((fileInput, index) => {
                console.log(`File input ${index}:`, fileInput.files);
            });

            formData.append('course', courseId);            

            fetch('/api/assignments/upload', {
                method: 'POST',
                body: formData,
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Upload successful:', data);
                    window.location.href = `/course/detail/${courseId}`;
                } else {
                    console.error('Upload failed:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });
</script>
<%- contentFor('title') %>Add Assignment